<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RabbitMQ集群 | 乔木先生</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="Java后端技术博客,专注Java后端学习与总结。Java,Spring,SpringBoot,SpringMVC,SpringCloud,Mybatis,Linux,css3,html5,Maven,git,github等技术文章。">
    <meta name="keywords" content="Java后端技术博客,专注Java后端学习与总结。Java,Spring,SpringBoot,SpringMVC,SpringCloud,Mybatis,Linux,css3,html5,Maven,git,github等技术文章。">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.a29a3543.css" as="style"><link rel="preload" href="/assets/js/app.f3b2a421.js" as="script"><link rel="preload" href="/assets/js/2.06b51e28.js" as="script"><link rel="preload" href="/assets/js/28.aad73944.js" as="script"><link rel="prefetch" href="/assets/js/10.25ab3c87.js"><link rel="prefetch" href="/assets/js/11.8cffc883.js"><link rel="prefetch" href="/assets/js/12.149374e6.js"><link rel="prefetch" href="/assets/js/13.5143bad0.js"><link rel="prefetch" href="/assets/js/14.d00979ca.js"><link rel="prefetch" href="/assets/js/15.5ed30ffd.js"><link rel="prefetch" href="/assets/js/16.45746ea5.js"><link rel="prefetch" href="/assets/js/17.f1db6066.js"><link rel="prefetch" href="/assets/js/18.3922538a.js"><link rel="prefetch" href="/assets/js/19.7562e59c.js"><link rel="prefetch" href="/assets/js/20.8a296438.js"><link rel="prefetch" href="/assets/js/21.bebe2d14.js"><link rel="prefetch" href="/assets/js/22.a2f38cf1.js"><link rel="prefetch" href="/assets/js/23.4702fb5d.js"><link rel="prefetch" href="/assets/js/24.76766b0b.js"><link rel="prefetch" href="/assets/js/25.4e296918.js"><link rel="prefetch" href="/assets/js/26.e9f8a341.js"><link rel="prefetch" href="/assets/js/27.d1e12903.js"><link rel="prefetch" href="/assets/js/29.1f69ecb2.js"><link rel="prefetch" href="/assets/js/3.04a7b8c9.js"><link rel="prefetch" href="/assets/js/30.31228ad4.js"><link rel="prefetch" href="/assets/js/31.876161e0.js"><link rel="prefetch" href="/assets/js/32.00970883.js"><link rel="prefetch" href="/assets/js/33.d6286171.js"><link rel="prefetch" href="/assets/js/34.6f7f8dea.js"><link rel="prefetch" href="/assets/js/35.61b61fb3.js"><link rel="prefetch" href="/assets/js/36.ff818b3d.js"><link rel="prefetch" href="/assets/js/37.3b4a7cce.js"><link rel="prefetch" href="/assets/js/38.c3e4cbf3.js"><link rel="prefetch" href="/assets/js/4.23b49261.js"><link rel="prefetch" href="/assets/js/5.cf7ce6d9.js"><link rel="prefetch" href="/assets/js/6.13b7e819.js"><link rel="prefetch" href="/assets/js/7.b64609cd.js"><link rel="prefetch" href="/assets/js/8.624f3e03.js"><link rel="prefetch" href="/assets/js/9.dfda272b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a29a3543.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="乔木先生" class="logo"> <span class="site-name can-hide">乔木先生</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><!----> <span class="title" style="display:;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/kas755c4/" class="nav-link">JavaSE</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java框架" class="dropdown-title"><!----> <span class="title" style="display:;">Java框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/24j4ehty/" class="nav-link">SpringCloud</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><!----> <span class="title" style="display:;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>NoSQL</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/bp3ikv4g/" class="nav-link">Redis</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><!----> <span class="title" style="display:;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>消息中间件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/vd45cpcf/" class="nav-link">RabbitMQ</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><!----> <span class="title" style="display:;">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/e938xib2/" class="nav-link">Linux</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><!----> <span class="title" style="display:;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/eb9ks77i/" class="nav-link">Git</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/qaomuu" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><!----> <span class="title" style="display:;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/kas755c4/" class="nav-link">JavaSE</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java框架" class="dropdown-title"><!----> <span class="title" style="display:;">Java框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/24j4ehty/" class="nav-link">SpringCloud</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><!----> <span class="title" style="display:;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>NoSQL</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/bp3ikv4g/" class="nav-link">Redis</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><!----> <span class="title" style="display:;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>消息中间件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/vd45cpcf/" class="nav-link">RabbitMQ</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><!----> <span class="title" style="display:;">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/e938xib2/" class="nav-link">Linux</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><!----> <span class="title" style="display:;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/eb9ks77i/" class="nav-link">Git</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/qaomuu" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>消息中间件</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/sm8jwpla/" class="sidebar-link">MQ的相关概念</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>RabbitMQ</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/vd45cpcf/" class="sidebar-link">RabbitMQ介绍</a></li><li><a href="/pages/kr5yv2xa/" class="sidebar-link">RabbitMQ安装&amp;常用命令</a></li><li><a href="/pages/hs9by9nl/" class="sidebar-link">RabbitMQ入门程序</a></li><li><a href="/pages/b2xtwkg7/" class="sidebar-link">RabbitMQ工作队列</a></li><li><a href="/pages/hf5rpdk0/" class="sidebar-link">RabbitMQ发布确认</a></li><li><a href="/pages/umb37yap/" class="sidebar-link">RabbitMQ交换机</a></li><li><a href="/pages/l98puwie/" class="sidebar-link">RabbitMQ死信队列</a></li><li><a href="/pages/0dmo0ykv/" class="sidebar-link">SpringBoot整合RabbitMQ</a></li><li><a href="/pages/8s5gukww/" class="sidebar-link">RabbitMQ延时队列</a></li><li><a href="/pages/mcht59cm/" class="sidebar-link">RabbitMQ发布确认高级</a></li><li><a href="/pages/5ctcr5a6/" class="sidebar-link">RabbitMQ其他知识点</a></li><li><a href="/pages/1kma3r88/" aria-current="page" class="active sidebar-link">RabbitMQ集群</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/1kma3r88/#搭建步骤" class="sidebar-link">搭建步骤</a></li><li class="sidebar-sub-header level2"><a href="/pages/1kma3r88/#镜像队列" class="sidebar-link">镜像队列</a></li><li class="sidebar-sub-header level2"><a href="/pages/1kma3r88/#haproxy-keepalive实现高可用负载均衡" class="sidebar-link">Haproxy+Keepalive实现高可用负载均衡</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/1kma3r88/#整体架构图" class="sidebar-link">整体架构图</a></li><li class="sidebar-sub-header level3"><a href="/pages/1kma3r88/#haproxy" class="sidebar-link">HAProxy</a></li><li class="sidebar-sub-header level3"><a href="/pages/1kma3r88/#keepalived实现双机-主备-热备" class="sidebar-link">Keepalived实现双机(主备)热备</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/1kma3r88/#federation-exchange" class="sidebar-link">Federation Exchange</a></li><li class="sidebar-sub-header level2"><a href="/pages/1kma3r88/#federation-queue" class="sidebar-link">Federation Queue</a></li><li class="sidebar-sub-header level2"><a href="/pages/1kma3r88/#shovel" class="sidebar-link">Shovel</a></li></ul></li></ul></section></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=%E4%B8%AD%E9%97%B4%E4%BB%B6" title="分类" data-v-06225672>中间件</a></li><li data-v-06225672><a href="/categories/?category=%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6" title="分类" data-v-06225672>消息中间件</a></li><li data-v-06225672><a href="/categories/?category=RabbitMQ" title="分类" data-v-06225672>RabbitMQ</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>乔木先生</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-12-09</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">RabbitMQ集群<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="搭建步骤"><a href="#搭建步骤" class="header-anchor">#</a> 搭建步骤</h2> <p>创建三台虚拟机，可以使用克隆，并修改3台机器的主机名称。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">vim</span> /etc/hostname
</code></pre></div><p>主机名尽量不要带符号！！！我带了 报错了。</p> <p><img src="https://file.qaomuu.com/blog/OiGswXTWB-qn56Wximncm9xIiFcfVTS9rp_JEXzUE14.png" alt="image"></p> <p>先知道本机的ip，使用<code>ifconfig</code> 命令查看，配置各个节点的hosts文件，让各个节点都能互相识别对方，三台机器保持一致即可。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">vim</span> /etc/hosts
</code></pre></div><p><img src="https://file.qaomuu.com/blog/1ZuvoAFMc9zDhR-_-Y0vmnhMIZdrWv93IhhGH1-yRYA.png" alt="image"></p> <p>确保各个节点的 cookie 文件使用的是同一个值，在centos1上执行远程操作命令:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">scp</span> /var/lib/rabbitmq/.erlang.cookie root@centos2:/var/lib/rabbitmq/.erlang.cookie
<span class="token function">scp</span> /var/lib/rabbitmq/.erlang.cookie root@centos3:/var/lib/rabbitmq/.erlang.cookie
</code></pre></div><p><img src="https://file.qaomuu.com/blog/e1qBq0tNZGxSCMlceMYftLAQGyLW_Ij-ZO-TP2CD1IE.png" alt="image"></p> <p>启动 RabbitMQ 服务，顺带启动 Erlang 虚拟机和 RbbitMQ 应用服务(在三台节点上分别执行以下命令)</p> <div class="language-bash extra-class"><pre class="language-bash"><code>rabbitmq-server <span class="token parameter variable">-detached</span>
</code></pre></div><p>在节点 2 执行：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># (rabbitmqctl stop 会将Erlang 虚拟机关闭，rabbitmqctl stop_app 只关闭 RabbitMQ 服务)</span>
rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl join_cluster rabbit@centos1
<span class="token comment"># 只启动应用服务：</span>
rabbitmqctl start_app
</code></pre></div><p><img src="https://file.qaomuu.com/blog/3N7pbpR_fLunPAkGQfYf2xagjAWCfnfiRan_OBDZab8.png" alt="image"></p> <p>在节点 3 执行：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl join_cluster rabbit@centos2
rabbitmqctl start_app
</code></pre></div><p><img src="https://file.qaomuu.com/blog/5k5kDSFPsoHs2PKqJlW5BMMRRWEm0qxsoL-h__WFI9Q.png" alt="image"></p> <p>集群状态：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>rabbitmqctl cluster_status
</code></pre></div><p><img src="https://file.qaomuu.com/blog/c0vdaP29DLskWjco1DLgsMHAj07mj7OzHNXR9_YMGu0.png" alt="image"></p> <p>需要重新设置用户，三台机器随便哪一台设置，因为是集群，通用的：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 创建账号</span>
rabbitmqctl add_user admin <span class="token number">123</span>

<span class="token comment"># 设置用户角色</span>
rabbitmqctl set_user_tags admin administrator

<span class="token comment"># 设置用户权限</span>
rabbitmqctl set_permissions <span class="token parameter variable">-p</span> <span class="token string">&quot;/&quot;</span> admin <span class="token string">&quot;.*&quot;</span> <span class="token string">&quot;.*&quot;</span> <span class="token string">&quot;.*&quot;</span>
</code></pre></div><p><img src="https://file.qaomuu.com/blog/NYJEJwmxnw_Cw__9qaaP0nkn_wQbI-Q9PviDMWd_wsY.png" alt="image"></p> <p>解除集群节点(centos2 和centos3机器分别执行，不解除不要执行)</p> <div class="language-bash extra-class"><pre class="language-bash"><code>rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl start_app
rabbitmqctl cluster_status
rabbitmqctl forget_cluster_node rabbit@node2 <span class="token comment"># (node1 机器上执行)</span>
</code></pre></div><h2 id="镜像队列"><a href="#镜像队列" class="header-anchor">#</a> 镜像队列</h2> <p>如果 RabbitMQ 集群中只有一个 Broker 节点，那么该节点的失效将导致整体服务的临时性不可用，并且也可能会导致消息的丢失。可以将所有消息都设置为持久化，并且对应队列的durable属性也设置为true，但是这样仍然无法避免由于缓存导致的问题：因为消息在发送之后和被写入磁盘井执行刷盘动作之间存在一个短暂却会产生问题的时间窗。通过 publisherconfirm 机制能够确保客户端知道哪些消息己经存入磁盘，尽管如此，一般不希望遇到因单点故障导致的服务不可用。</p> <p>引入镜像队列(Mirror Queue)的机制，可以将队列镜像到集群中的其他 Broker 节点之上，如果集群中的一个节点失效了，队列能自动地切换到镜像中的另一个节点上以保证服务的可用性。</p> <p><strong>搭建步骤</strong></p> <p>启动三台集群节点，随便找一个节点添加 policy：</p> <p><img src="https://file.qaomuu.com/blog/T0P2dQKJxA0QJjrHf6qrrb9WsvT1Af7qK8_0Tw75EiY.png" alt="image"></p> <blockquote><p>Pattern根据自己的队列来配置</p></blockquote> <p><img src="https://file.qaomuu.com/blog/14A4oHX4pWxQn2-qlBar2jb7hI4i13Ja3t9wxrF_CAs.png" alt="image"></p> <p>在centos1上创建一个队列发送一条消息，队列存在镜像队列，停掉centos1之后发现centos2成为镜像队列：</p> <p><img src="https://file.qaomuu.com/blog/ggQXLBE67P42XfmdWHNcYyS4YI28Ni_NsgZ2Wh_aZLs.png" alt="image"></p> <p><img src="https://file.qaomuu.com/blog/_j9wwqZAUuTsMmWi1JXkrwk5iQiNkzOyjg-7tXHksoE.png" alt="image"></p> <p>就算整个集群只剩下一台机器了，依然能消费队列里面的消息，说明队列里面的消息被镜像队列传递到相应机器里面了。</p> <blockquote><p>给centos1发消息，不处理消息，然后停掉centos1，这时centos2就可以消费消息</p></blockquote> <p><img src="https://file.qaomuu.com/blog/geA9-UFF_xnoXDyPdP5KGWwuSf2hBFOW67gfJnnhFys.png" alt="image"></p> <h2 id="haproxy-keepalive实现高可用负载均衡"><a href="#haproxy-keepalive实现高可用负载均衡" class="header-anchor">#</a> Haproxy+Keepalive实现高可用负载均衡</h2> <blockquote><p>文档里面含糊不清，直接复制的文档，后面接触到了再补</p></blockquote> <h3 id="整体架构图"><a href="#整体架构图" class="header-anchor">#</a> 整体架构图</h3> <p><img src="https://file.qaomuu.com/blog/aSyXMlwBrb63PGKyIHbwqelEL2Juy7Bweh1srw3pLYc.png" alt="image"></p> <h3 id="haproxy"><a href="#haproxy" class="header-anchor">#</a> HAProxy</h3> <p>HAProxy 提供高可用性、负载均衡及基于TCPHTTP 应用的代理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案，包括 Twitter、Reddit、StackOverflow、GitHub 在内的多家知名互联网公司在使用。</p> <p>HAProxy 实现了一种事件驱动、单一进程模型，此模型支持非常大的井发连接数。</p> <blockquote><p>nginx、lvs、haproxy之间的区别: <a href="http://www.ha97.com/5646.html" target="_blank" rel="noopener noreferrer">http://www.ha97.com/5646.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p><strong>搭建步骤：</strong></p> <p>下载 haproxy(在centos1和centos2)</p> <div class="language-bash extra-class"><pre class="language-bash"><code>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> haproxy
</code></pre></div><p>修改centos1和centos2的haproxy.cfg</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">vim</span> /etc/haproxy/haproxy.cfg
</code></pre></div><p>需要修改红色 IP 为当前机器 IP</p> <p><img src="https://file.qaomuu.com/blog/R3uPawBmUv_wa-FmZBdaUqqJrKz5w-4XF7khbE-X-70.png" alt="image"></p> <p>在两台节点启动 haproxy</p> <div class="language-bash extra-class"><pre class="language-bash"><code>haproxy <span class="token parameter variable">-f</span> /etc/haproxy/haproxy.cfg
<span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> haproxy
</code></pre></div><p>访问地址</p> <p>http://10.211.55.71:8888/stats</p> <h3 id="keepalived实现双机-主备-热备"><a href="#keepalived实现双机-主备-热备" class="header-anchor">#</a> Keepalived实现双机(主备)热备</h3> <p>如果配置的HAProxy主机突然宕机或者网卡失效，就算RbbitMQ集群没有任何故障但是对于外界的客户端来说所有的连接都会被断开，结果是灾难性的，为了确保负载均衡服务的可靠性同样显得十分重要。</p> <p>Keepalived它能够通过自身健康检查、资源接管功能做高可用(双机热备)，实现故障转移。</p> <p><strong>搭建步骤：</strong></p> <p>下载 keepalived</p> <div class="language-bash extra-class"><pre class="language-bash"><code>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> keepalived
</code></pre></div><p>修改节点centos1配置文件：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">vim</span> /etc/keepalived/keepalived.conf
</code></pre></div><p>把资料里面的 keepalived.conf 修改之后替换</p> <blockquote><p>没有资料</p></blockquote> <p>节点centos2配置文件</p> <ul><li>需要修改global_defs 的 router_id,如:nodeB</li> <li>其次要修改 vrrp_instance_VI 中 state 为&quot;BACKUP&quot;；</li> <li>最后要将priority 设置为小于 100 的值</li></ul> <p>添加 haproxy_chk.sh</p> <p>(为了防止 HAProxy 服务挂掉之后 Keepalived 还在正常工作而没有切换到 Backup 上，所以这里需要编写一个脚本来检测 HAProxy 务的状态,当 HAProxy 服务挂掉之后该脚本会自动重启HAProxy 的服务，如果不成功则关闭 Keepalived 服务，这样便可以切换到 Backup 继续工作)</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 可以上传文件</span>
<span class="token function">vim</span> /etc/keepalived/haproxy_chk.sh
<span class="token comment"># 修改权限 </span>
<span class="token function">chmod</span> <span class="token number">777</span> /etc/keepalived/haproxy_chk.sh
</code></pre></div><blockquote><p>这里也没有文件</p></blockquote> <p>启动 keepalive(centos1和centos2启动)</p> <div class="language-bash extra-class"><pre class="language-bash"><code>systemctl start keepalived
</code></pre></div><p>观察 Keepalived 的日志</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">tail</span> <span class="token parameter variable">-f</span> /var/log/messages <span class="token parameter variable">-n</span> <span class="token number">200</span>
</code></pre></div><p>观察最新添加的 vip</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">ip</span> <span class="token function">add</span> show
</code></pre></div><p>centos1模拟 keepalived 关闭状态</p> <div class="language-bash extra-class"><pre class="language-bash"><code>systemctl stop keepalived
</code></pre></div><p>使用 vip 地址来访问 rabbitmq 集群</p> <h2 id="federation-exchange"><a href="#federation-exchange" class="header-anchor">#</a> Federation Exchange</h2> <p>(broker 北京)，(broker 深圳)彼此之间相距甚远，网络延迟是一个不得不面对的问题。有一个在北京的业务(Client 北京) 需要连接(broker 北京)，向其中的交换器 exchangeA 发送消息，此时的网络延迟很小，(Client 北京)可以迅速将消息发送至 exchangeA 中，就算在开启了 publisherconfirm 机制或者事务机制的情况下，也可以迅速收到确认信息。</p> <p>此时又有个在深圳的业务(Client 深圳)需要向 exchangeA 发送消息， 那么(Client 深圳) (broker 北京)之间有很大的网络延迟，(Client 深圳) 将发送消息至 exchangeA 会经历一定的延迟，尤其是在开启了 publisherconfirm 机制或者事务机制的情况下，(Client 深圳) 会等待很长的延迟时间来接收(broker 北京)的确认信息，进而必然造成这条发送线程的性能降低，甚至造成一定程度上的阻塞。</p> <p>将业务(Client 深圳)部署到北京的机房可以解决这个问题，但是如果(Client 深圳)调用的另些服务都部署在深圳，那么又会引发新的时延问题，总不见得将所有业务全部部署在一个机房，那么容灾又何以实现？ 这里使用 Federation 插件就可以很好地解决这个问题。</p> <p><img src="https://file.qaomuu.com/blog/Qj05PmUbvXiEkibDuf4JlztcMeOOtWyKms4paiuEQyM.png" alt="image"></p> <p><strong>搭建步骤：</strong></p> <p>需要保证每台节点单独运行</p> <p>在每台机器上开启 federation 相关插件</p> <div class="language-bash extra-class"><pre class="language-bash"><code>rabbitmq-plugins <span class="token builtin class-name">enable</span> rabbitmq_federation
rabbitmq-plugins <span class="token builtin class-name">enable</span> rabbitmq_federation_management
</code></pre></div><p><img src="https://file.qaomuu.com/blog/k8ae08oGsrAfPTRLcqKg74b6pYWPO_6KzWRNLIEBHFw.png" alt="image"></p> <p>原理图(先运行 consumer 在contos2创建 fed_exchange)</p> <p><img src="https://file.qaomuu.com/blog/dzbsmr20kCfv7eaabzxZDV4AIaDXu9NJRrro9dnpWHA.png" alt="image"></p> <p>在 downstream(contos2)配置 upstream(contos1)</p> <p><img src="https://file.qaomuu.com/blog/cn1eOBFH37IOkSRlA6g6A0NQwpduMyRW0zNY8gNYBHY.png" alt="image"></p> <p>添加 policy</p> <p><img src="https://file.qaomuu.com/blog/IkWr0P6LljRsDGGHkB1ms5BZgmIQrnB9N_N0d_qFvhg.png" alt="image"></p> <p>成功的前提</p> <p><img src="https://file.qaomuu.com/blog/uWD_8FHkunP6-scqMxT-kikFqmiNHWFz_x7nse4tV9A.png" alt="image"></p> <h2 id="federation-queue"><a href="#federation-queue" class="header-anchor">#</a> Federation Queue</h2> <p>联邦队列可以在多个 Broker 节点(或者集群)之间为单个队列提供均衡负载的功能。一个联邦队列可以连接一个或者多个上游队列(upstream queue)，并从这些上游队列中获取消息以满足本地消费者消费消息的需求。</p> <p><strong>搭建步骤：</strong></p> <p><img src="https://file.qaomuu.com/blog/EUysWRGM1d4faPAeBqgzrYBVsth5xlhcTjiPShk7og8.png" alt="image"></p> <p>添加 upstream(同上)</p> <p>添加 policy</p> <p><img src="https://file.qaomuu.com/blog/k6UcOmJLeZqp1GNrFBUtW5uzETQ8N3_qy2nrtxGNTuk.png" alt="image"></p> <h2 id="shovel"><a href="#shovel" class="header-anchor">#</a> Shovel</h2> <p>Federation 具备的数据转发功能类似，Shovel 够可靠、持续地从一个 Broker 中的队列(作为源端，即source)拉取数据并转发至另一个 Broker 中的交换器(作为目的端，即 destination)。作为源端的队列和作为目的端的交换器可以同时位于同一个 Broker，也可以位于不同的 Broker 上。Shovel 可以翻译为&quot;铲子&quot;，是一种比较形象的比喻，这个&quot;铲子&quot;可以将消息从一方&quot;铲子&quot;另一方。Shovel 行为就像优秀的客户端应用程序能够负责连接源和目的地、负责消息的读写及负责连接失败问题的处理。</p> <p><strong>搭建步骤：</strong></p> <p>开启插件(需要的机器都开启)</p> <div class="language-bash extra-class"><pre class="language-bash"><code>rabbitmq-plugins <span class="token builtin class-name">enable</span> rabbitmq_shovel
rabbitmq-plugins <span class="token builtin class-name">enable</span> rabbitmq_shovel_management
</code></pre></div><p><img src="https://file.qaomuu.com/blog/e3etzvu4HSy8TyuFbv-gWxG0Gv1gwGh7xdPwmdpZ02g.png" alt="image"></p> <p>原理图(在源头发送的消息直接回进入到目的地队列)</p> <p><img src="https://file.qaomuu.com/blog/AcmDlztNG0-U0_X2BvghCnGVhyWRQn28-8OflWK0JSY.png" alt="image"></p> <p>添加 shovel 源和目的地</p> <p><img src="https://file.qaomuu.com/blog/5QWoYrrxUTduXhhcKQpV4X0Rv2wf3oExmQnkJpJKtR8.png" alt="image"></p></div></div> <!----> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=RabbitMQ" title="标签">#RabbitMQ</a><a href="/tags/?tag=TODO" title="标签">#TODO</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/11/25, 18:48:06</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/5ctcr5a6/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">RabbitMQ其他知识点</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/5ctcr5a6/" class="prev">RabbitMQ其他知识点</a></span> <!----></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/jsf92i5m/"><div>
            SpringBoot整合Redis
            <!----></div></a> <span class="date">12-21</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/a7v81744/"><div>
            Redis Java客户端Jedis
            <!----></div></a> <span class="date">12-20</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/lp31htbk/"><div>
            MacOS安装Git
            <!----></div></a> <span class="date">12-19</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2022
    <span>| <a href="https://beian.miit.gov.cn/#/Integrated/index" target="_blank">浙ICP备2022027766号-1</a><br><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33011002016801" target="_blank">浙公网安备 33011002016801号</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f3b2a421.js" defer></script><script src="/assets/js/2.06b51e28.js" defer></script><script src="/assets/js/28.aad73944.js" defer></script>
  </body>
</html>
